<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>월별 메뉴 매출 현황</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: white;
            padding: 40px;
            font-family: 'Noto Sans KR', sans-serif;
            display: block;
            /* Override flex from style.css body if needed */
        }

        .sales-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .sales-header h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .sales-table th,
        .sales-table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: right;
        }

        .sales-table th {
            background-color: #e0e0e0;
            text-align: center;
            font-weight: bold;
        }

        .sales-table td:first-child {
            text-align: left;
            font-weight: bold;
        }

        .sales-table tr:last-child td {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="sales-header">
        <h2>월별 메뉴 매출 현황</h2>
        <button class="close-btn" onclick="location.href='/kiosk.html'">X</button>
    </div>

    <div id="loading" style="text-align:center;">데이터 불러오는 중...</div>

    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
        <div style="flex: 1; min-width: 300px;">
            <canvas id="salesChart"></canvas>
        </div>
        <div style="flex: 1; min-width: 300px;">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>

    <table class="sales-table" id="sales-table" style="display:none;">
        <thead>
            <tr id="table-header">
                <th>메뉴 / 월</th>
                <th>메뉴별 월총합계</th>
            </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            $.get('/api/sales/monthly', function (data) {
                renderTable(data);
                renderChart(data);
                $('#loading').hide();
                $('#sales-table').show();
            }).fail(function () {
                $('#loading').text('데이터를 불러오는데 실패했습니다.');
            });
        });

        function renderTable(data) {
            const months = data.months;
            const rows = data.rows;
            const monthTotals = data.monthTotals;
            const grandTotal = data.grandTotal;

            const headerRow = $('#table-header');
            headerRow.find('th:gt(0)').remove();

            months.forEach(m => {
                headerRow.append(`<th>${m}</th>`);
            });
            headerRow.append('<th>메뉴별 월총합계</th>');

            const tbody = $('#table-body');
            tbody.empty();

            rows.forEach(row => {
                let tr = `<tr><td>${row.menuName}</td>`;
                months.forEach(m => {
                    let val = row[m] || 0;
                    tr += `<td>${val.toLocaleString()}</td>`;
                });
                tr += `<td>${row.total.toLocaleString()}</td></tr>`;
                tbody.append(tr);
            });

            let footerHtml = `<tr><td>월별 합계</td>`;
            months.forEach(m => {
                footerHtml += `<td>${(monthTotals[m] || 0).toLocaleString()}</td>`;
            });
            footerHtml += `<td>${grandTotal.toLocaleString()}</td></tr>`;

            tbody.append(footerHtml);
        }

        let salesChart = null;
        let distChart = null;

        function renderChart(data) {
            // 1. Monthly Chart (Last 6 Months)
            const ctx1 = document.getElementById('salesChart').getContext('2d');
            const sortedMonths = [...data.months].sort();
            const last6Months = sortedMonths.slice(-6); // Take last 6
            const dataPoints = last6Months.map(m => data.monthTotals[m] || 0);

            if (salesChart) salesChart.destroy();

            salesChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: '월별 매출 (최근 6개월)',
                        data: dataPoints,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => v.toLocaleString() + '원' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: { label: c => c.parsed.y.toLocaleString() + '원' }
                        }
                    }
                }
            });

            // 2. Distribution Chart (Menu/Member Breakdown)
            const ctx2 = document.getElementById('distributionChart').getContext('2d');

            // Sort rows by total descending
            const sortedRows = [...data.rows].sort((a, b) => b.total - a.total);
            const labels = sortedRows.map(r => r.menuName);
            const totals = sortedRows.map(r => r.total);

            // Generate basic colors
            const bgColors = labels.map((_, i) => `hsl(${i * 137.508}, 70%, 60%)`);

            if (distChart) distChart.destroy();

            distChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: totals,
                        backgroundColor: bgColors,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: '항목별 총 매출 비중' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    label += context.parsed.toLocaleString() + '원';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>